---
title: "Supplementary information"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```


# Setup

Set up the workflow pipeline and options. We first load the `targets` package and remove the potentially outdated workflow.

```{r}
library(targets)
library(tibble)
library(tidyr)
library(dplyr)
library(scoringutils)
library(ggplot2)
library(purrr)
library(here)
tar_unscript()
```

We now define shared global options across our workflow and load R functions from the `R` folder.


```{targets globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
library(purrr)
library(here)
functions <- list.files(here("R"), full.names = TRUE)
walk(functions, source)
tar_option_set(
  packages = c("tibble", "tidyr", "dplyr", "scoringutils", "ggplot2", "purrr")
)
```

# Toy example

An exponential process with a certain rate r; and 3 forecasting models: one that thinks it’s exponential with rate r-a , one that thinks it’s exponential with rate r+a and one that thinks it’s linear; and compare scoring on linear and log scale for increasing horizons.

```{targets toy_scenarios, tar_simple = TRUE}
expand_grid(
  init = c(100),
  r = c(0, 0.01, 0.1, -0.01, -0.1),
  r_error = c(0, 0.01, 0.05, 0.1, -0.01, -0.05, -0.1),
  additive_error = c(0, 1, 10, -1, -10)
) |> 
  mutate(id = 1:n())
```

```{targets toy_simulations, tar_simple = TRUE}
toy_scenarios |>
  rowwise() |>
  mutate(y = list(
    simulate_exp_poisson(init = init, time = 10, growth = r + r_error,
                         additive_error = additive_error, sims = 1000)
    )
  ) |>
  unnest(cols = c(y))
```

```{targets toy_truth, tar_simple = TRUE}
toy_simulations |>
  filter(r_error == 0, additive_error == 0, sim == 1) |>
  select(init, r, time, true_value = obs)
```

```{targets toy_forecasts, tar_simple = TRUE}
toy_simulations |>
  filter(!(r_error == 0 & additive_error == 0)) |>
  select(init, r, r_error, additive_error, time, sample = sim,
         prediction = obs) |>
  left_join(toy_truth, by = c("init", "r", "time"))
```

```{targets, toy_scores, tar_simple = TRUE}
toy_forecasts |>
  eval_forecasts(
    summarise_by = c("init", "r", "r_error", "additive_error"),
    metrics = c("crps")
  )
```

```{targets, toy_log_scores, tar_simple = TRUE}
toy_forecasts |>
  mutate(across(.cols = c("true_value", "prediction"), ~ log(.x))) |>
  eval_forecasts(
    summarise_by = c("init", "r", "r_error", "additive_error"),
    metrics = c("crps")
  )
```

# Pipeline

If all`{targets}` were run in non-interactive mode, then the pipeline is ready to run using the following,

```{r, eval = FALSE}
tar_make()
```

The complete pipeline can be visualised using,

```{r, eval = FALSE}
tar_visnetwork()
```